version: '3'

vars:
  KUBECONFIG: ./infra/terraform/kubeconfig.yaml
  TERRAFORM_DIR: ./infra/terraform
  K8S_DIR: ./infra/k8s
  APPS_DIR: ./apps

tasks:
  default:
    desc: List all available tasks
    cmds:
      - task --list

  # Local k3d + Tilt development tasks
  local:setup:
    desc: Create k3d cluster for local development
    cmds:
      - ./scripts/k3d-setup.sh

  local:start:
    desc: Start Tilt for local development
    cmds:
      - tilt up

  local:down:
    desc: Stop Tilt (keeps cluster running)
    cmds:
      - tilt down

  local:teardown:
    desc: Delete k3d cluster
    cmds:
      - k3d cluster delete roussev-local

  local:status:
    desc: Check status of local k3d cluster
    cmds:
      - k3d cluster list
      - echo ""
      - kubectl get nodes
      - echo ""
      - kubectl get pods

  local:logs:
    desc: View Tilt logs
    cmds:
      - tilt logs

  # Development tasks
  dev:items-service:
    desc: Run items-service in development mode with hot reload
    dir: apps/items-service
    cmds:
      - bun install && bun run dev

  dev:items-service:postgres:
    desc: Run items-service locally with PostgreSQL connection (requires port-forward)
    dir: apps/items-service
    cmds:
      - |
        echo "Make sure PostgreSQL is port-forwarded: task postgres:port-forward"
        echo "Loading credentials from .env..."
        set -a
        source ../../.env
        set +a
        export DB_HOST=localhost
        export DB_PORT=5432
        export DB_USER=$POSTGRES_USER
        export DB_PASSWORD=$POSTGRES_PASSWORD
        export DB_NAME=$POSTGRES_DB
        bun install && bun run dev

  dev:website-app:
    desc: Run website-app in development mode with hot reload
    dir: apps/website-app
    cmds:
      - bun install && bun run dev

  # Docker tasks
  docker:build:items-service:
    desc: Build Docker image for items-service
    cmds:
      - docker build -t items-service:local ./apps/items-service

  docker:build:website-app:
    desc: Build Docker image for website-app
    cmds:
      - docker build -t website-app:local ./apps/website-app

  docker:build:all:
    desc: Build Docker images for all apps
    cmds:
      - task: docker:build:items-service
      - task: docker:build:website-app

  docker:run:items-service:
    desc: Run items-service Docker container locally
    cmds:
      - docker run --rm -p 8080:8080 items-service:local

  docker:run:website-app:
    desc: Run website-app Docker container locally
    cmds:
      - docker run --rm -p 8080:8080 website-app:local

  # Terraform tasks
  tf:init:
    desc: Initialize Terraform
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - terraform init

  tf:plan:
    desc: Run Terraform plan
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - terraform plan

  tf:apply:
    desc: Apply Terraform configuration
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - terraform apply

  tf:destroy:
    desc: Destroy Terraform infrastructure
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - terraform destroy

  tf:output:
    desc: Show Terraform outputs
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - terraform output

  tf:get-ip:
    desc: Get server IP from Terraform
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - terraform output -raw server_ip

  # Kubernetes tasks
  k8s:config:
    desc: Set KUBECONFIG environment variable
    cmds:
      - echo "export KUBECONFIG={{.KUBECONFIG}}"

  k8s:status:
    desc: Check status of production Kubernetes cluster
    cmds:
      - echo "=================================================="
      - echo "üîç Kubernetes Cluster Status"
      - echo "=================================================="
      - echo ""
      - echo "üì¶ Pods:"
      - kubectl --kubeconfig={{.KUBECONFIG}} get pods -o wide
      - echo ""
      - echo "üíæ Resource Usage:"
      - kubectl --kubeconfig={{.KUBECONFIG}} top pods 2>/dev/null || echo "Metrics not available"
      - echo ""
      - echo "üåê Services:"
      - kubectl --kubeconfig={{.KUBECONFIG}} get services
      - echo ""
      - echo "üîó Ingress:"
      - kubectl --kubeconfig={{.KUBECONFIG}} get ingress
      - echo ""
      - echo "üñ•Ô∏è  Node Status:"
      - kubectl --kubeconfig={{.KUBECONFIG}} get nodes
      - echo ""
      - kubectl --kubeconfig={{.KUBECONFIG}} top node 2>/dev/null || echo "Node metrics not available"
      - echo ""
      - echo "üìä Deployments:"
      - kubectl --kubeconfig={{.KUBECONFIG}} get deployments
      - echo ""

  k8s:get-pods:
    desc: Get all pods
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} get pods

  k8s:get-services:
    desc: Get all services
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} get services

  k8s:get-ingress:
    desc: Get all ingress resources
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} get ingress

  k8s:get-all:
    desc: Get all Kubernetes resources
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} get all

  k8s:logs:items-service:
    desc: Get logs from items-service
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} logs -l app=items-service --tail=100 -f

  k8s:logs:website-app:
    desc: Get logs from website-app
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} logs -l app=website-app --tail=100 -f

  k8s:describe:items-service:
    desc: Describe items-service deployment
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} describe deployment items-service

  k8s:describe:website-app:
    desc: Describe website-app deployment
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} describe deployment website-app

  # Deployment tasks
  deploy:items-service:
    desc: Deploy items-service to Kubernetes
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f {{.K8S_DIR}}/apps/items-service-deployment.yaml
      - echo "‚úÖ items-service deployed"
      - echo "Waiting for rollout to complete..."
      - kubectl --kubeconfig={{.KUBECONFIG}} rollout status deployment/items-service --timeout=120s

  deploy:website-app:
    desc: Deploy website-app to Kubernetes
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f {{.K8S_DIR}}/apps/website-app-deployment.yaml

  deploy:headlamp:
    desc: Deploy Headlamp Kubernetes Dashboard
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f {{.K8S_DIR}}/apps/headlamp-deployment.yaml
      - echo "‚úÖ Headlamp deployed"
      - echo "Waiting for rollout to complete..."
      - kubectl --kubeconfig={{.KUBECONFIG}} rollout status deployment/headlamp -n kube-system --timeout=120s

  deploy:all:
    desc: Deploy all apps to Kubernetes
    cmds:
      - task: deploy:items-service
      - task: deploy:website-app
      - task: deploy:headlamp

  deploy:items-service:with-postgres:
    desc: Deploy PostgreSQL and items-service together
    cmds:
      - task: deploy:postgres
      - echo "Waiting for PostgreSQL to be ready before deploying items-service..."
      - sleep 5
      - task: deploy:items-service
      - echo "‚úÖ PostgreSQL and items-service deployed successfully!"

  deploy:cert-manager:
    desc: Deploy cert-manager
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml

  deploy:cluster-issuer:
    desc: Deploy Let's Encrypt cluster issuer
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f {{.K8S_DIR}}/cert-manager/cluster-issuer.yaml

  deploy:jaeger:
    desc: Deploy Jaeger for distributed tracing
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f {{.K8S_DIR}}/observability/jaeger-deployment.yaml
      - echo "Jaeger deployed"
      - echo "Waiting for rollout to complete..."
      - kubectl --kubeconfig={{.KUBECONFIG}} rollout status deployment/jaeger --timeout=120s
      - echo ""
      - echo "Jaeger UI available at https://app.roussev.com/jaeger"

  deploy:prometheus:
    desc: Deploy Prometheus for metrics collection
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f {{.K8S_DIR}}/observability/prometheus-deployment.yaml
      - echo "Prometheus deployed"
      - echo "Waiting for rollout to complete..."
      - kubectl --kubeconfig={{.KUBECONFIG}} rollout status deployment/prometheus --timeout=120s
      - echo ""
      - echo "Prometheus UI available at https://app.roussev.com/prometheus"

  deploy:grafana:
    desc: Deploy Grafana for metrics visualization
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f {{.K8S_DIR}}/observability/grafana-deployment.yaml
      - echo "Grafana deployed"
      - echo "Waiting for rollout to complete..."
      - kubectl --kubeconfig={{.KUBECONFIG}} rollout status deployment/grafana --timeout=120s
      - echo ""
      - echo "Grafana UI available at https://app.roussev.com/grafana"
      - echo "Public viewing enabled (Viewer role)"
      - echo "Admin login - admin/admin"

  deploy:loki:
    desc: Deploy Loki for log aggregation
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f {{.K8S_DIR}}/observability/loki-deployment.yaml
      - echo "Loki deployed"
      - echo "Waiting for rollout to complete..."
      - kubectl --kubeconfig={{.KUBECONFIG}} rollout status deployment/loki --timeout=120s
      - echo ""
      - echo "Loki API available at https://app.roussev.com/loki"

  deploy:promtail:
    desc: Deploy Promtail for log collection
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f {{.K8S_DIR}}/observability/promtail-deployment.yaml
      - echo "Promtail deployed"
      - echo "Waiting for rollout to complete..."
      - kubectl --kubeconfig={{.KUBECONFIG}} rollout status daemonset/promtail --timeout=120s
      - echo ""
      - echo "Promtail collecting logs from all pods"

  deploy:observability:
    desc: Deploy full observability stack (Jaeger, Prometheus, Loki, Grafana)
    cmds:
      - task: deploy:jaeger
      - task: deploy:prometheus
      - task: deploy:loki
      - task: deploy:promtail
      - task: deploy:grafana

  # Rollout tasks
  rollout:restart:items-service:
    desc: Restart items-service deployment
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} rollout restart deployment/items-service

  rollout:restart:website-app:
    desc: Restart website-app deployment
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} rollout restart deployment/website-app

  rollout:status:items-service:
    desc: Check rollout status for items-service
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} rollout status deployment/items-service

  rollout:status:website-app:
    desc: Check rollout status for website-app
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} rollout status deployment/website-app

  # DNS and networking tasks
  dns:clear-cache:
    desc: Clear DNS cache (macOS)
    cmds:
      - ./scripts/clear-dns-cache.sh

  dns:check:
    desc: Check DNS resolution for roussev.com
    cmds:
      - dig @8.8.8.8 roussev.com A +short
      - dig @1.1.1.1 roussev.com A +short
      - dig roussev.com A +short

  # Health check tasks
  health:items-service:
    desc: Check health of items-service (local)
    cmds:
      - curl -s https://app.roussev.com/items/v1/health | jq

  health:website-app:
    desc: Check health of website-app (local)
    cmds:
      - curl -s https://roussev.com/health | jq

  clean:docker:
    desc: Clean Docker images
    cmds:
      - docker rmi items-service:local website-app:local || true

  # Port forwarding tasks
  port-forward:items-service:
    desc: Port forward to items-service pod
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} port-forward svc/items-service 8080:80

  port-forward:website-app:
    desc: Port forward to website-app pod
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} port-forward svc/website-app 8080:80

  # SSH tasks
  ssh:
    desc: SSH into the K3s server
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - ssh -i ssh_key.pem -o StrictHostKeyChecking=no root@$(terraform output -raw server_ip)

  # Hetzner CSI Driver tasks
  deploy:hetzner-csi:
    desc: Install Hetzner CSI driver (required for Hetzner Cloud Volumes)
    cmds:
      - echo "‚ö†Ô∏è  Make sure you have created the hcloud secret first!"
      - echo "Run - kubectl --kubeconfig={{.KUBECONFIG}} create secret generic hcloud --from-literal=token=YOUR_HETZNER_API_TOKEN -n kube-system"
      - echo ""
      - echo "Installing Hetzner CSI driver..."
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f https://raw.githubusercontent.com/hetznercloud/csi-driver/main/deploy/kubernetes/hcloud-csi.yml
      - echo "Waiting for CSI driver to be ready..."
      - kubectl --kubeconfig={{.KUBECONFIG}} wait --namespace kube-system --for=condition=ready pod --selector=app=hcloud-csi-controller --timeout=300s
      - echo "‚úÖ Hetzner CSI driver installed successfully!"
      - kubectl --kubeconfig={{.KUBECONFIG}} get storageclass

  check:hetzner-csi:
    desc: Check if Hetzner CSI driver is installed
    cmds:
      - echo "Checking Hetzner CSI driver..."
      - kubectl --kubeconfig={{.KUBECONFIG}} get pods -n kube-system | grep hcloud || echo "‚ùå Hetzner CSI driver not found"
      - echo ""
      - echo "Storage classes:"
      - kubectl --kubeconfig={{.KUBECONFIG}} get storageclass

  # PostgreSQL tasks
  postgres:create-secret:
    desc: Create PostgreSQL secret from .env file
    cmds:
      - |
        set -a
        source .env
        set +a
        kubectl --kubeconfig={{.KUBECONFIG}} create secret generic postgres-secret \
          --from-literal=POSTGRES_USER="$POSTGRES_USER" \
          --from-literal=POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
          --from-literal=POSTGRES_DB="$POSTGRES_DB" \
          --dry-run=client -o yaml | kubectl --kubeconfig={{.KUBECONFIG}} apply -f -
      - echo "‚úÖ PostgreSQL secret created/updated successfully"

  postgres:delete-secret:
    desc: Delete PostgreSQL secret
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} delete secret postgres-secret --ignore-not-found=true
      - echo "‚úÖ PostgreSQL secret deleted"

  deploy:postgres:
    desc: Deploy PostgreSQL with persistent storage
    deps:
      - postgres:create-secret
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f {{.K8S_DIR}}/storage/postgres-pv.yaml
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f {{.K8S_DIR}}/storage/postgres-pvc.yaml
      - kubectl --kubeconfig={{.KUBECONFIG}} apply -f {{.K8S_DIR}}/storage/postgres-statefulset.yaml
      - echo "Waiting for PostgreSQL to be ready..."
      - kubectl --kubeconfig={{.KUBECONFIG}} wait --for=condition=ready pod -l app=postgres --timeout=300s
      - echo "‚úÖ PostgreSQL deployed successfully"

  k8s:get-pv:
    desc: Get all persistent volumes
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} get pv

  k8s:get-pvc:
    desc: Get all persistent volume claims
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} get pvc

  k8s:logs:postgres:
    desc: Get logs from PostgreSQL
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} logs -l app=postgres --tail=100 -f

  k8s:describe:postgres:
    desc: Describe PostgreSQL statefulset
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} describe statefulset postgres

  postgres:connect:
    desc: Connect to PostgreSQL using psql
    cmds:
      - |
        POSTGRES_USER=$(kubectl --kubeconfig={{.KUBECONFIG}} get secret postgres-secret -o jsonpath='{.data.POSTGRES_USER}' | base64 -d)
        POSTGRES_DB=$(kubectl --kubeconfig={{.KUBECONFIG}} get secret postgres-secret -o jsonpath='{.data.POSTGRES_DB}' | base64 -d)
        kubectl --kubeconfig={{.KUBECONFIG}} exec -it postgres-0 -- psql -U "$POSTGRES_USER" -d "$POSTGRES_DB"

  postgres:status:
    desc: Check PostgreSQL status
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} get pv
      - kubectl --kubeconfig={{.KUBECONFIG}} get pvc
      - kubectl --kubeconfig={{.KUBECONFIG}} get statefulset postgres
      - kubectl --kubeconfig={{.KUBECONFIG}} get pods -l app=postgres
      - kubectl --kubeconfig={{.KUBECONFIG}} get svc postgres
      - echo ""
      - echo "PostgreSQL Credentials (from secret):"
      - |
        POSTGRES_USER=$(kubectl --kubeconfig={{.KUBECONFIG}} get secret postgres-secret -o jsonpath='{.data.POSTGRES_USER}' | base64 -d)
        POSTGRES_DB=$(kubectl --kubeconfig={{.KUBECONFIG}} get secret postgres-secret -o jsonpath='{.data.POSTGRES_DB}' | base64 -d)
        echo "  User: $POSTGRES_USER"
        echo "  Database: $POSTGRES_DB"

  postgres:port-forward:
    desc: Port forward to PostgreSQL
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} port-forward svc/postgres 5432:5432

  postgres:backup:
    desc: Backup PostgreSQL database
    cmds:
      - |
        POSTGRES_USER=$(kubectl --kubeconfig={{.KUBECONFIG}} get secret postgres-secret -o jsonpath='{.data.POSTGRES_USER}' | base64 -d)
        POSTGRES_DB=$(kubectl --kubeconfig={{.KUBECONFIG}} get secret postgres-secret -o jsonpath='{.data.POSTGRES_DB}' | base64 -d)
        BACKUP_FILE="backup-$(date +%Y%m%d-%H%M%S).sql"
        kubectl --kubeconfig={{.KUBECONFIG}} exec postgres-0 -- pg_dump -U "$POSTGRES_USER" "$POSTGRES_DB" > "$BACKUP_FILE"
        echo "‚úÖ Backup saved to $BACKUP_FILE"

  postgres:disk-usage:
    desc: Check PostgreSQL disk usage
    cmds:
      - kubectl --kubeconfig={{.KUBECONFIG}} exec postgres-0 -- df -h /var/lib/postgresql/data

  postgres:show-credentials:
    desc: Show PostgreSQL credentials from secret
    cmds:
      - |
        echo "PostgreSQL Credentials:"
        echo "  User: $(kubectl --kubeconfig={{.KUBECONFIG}} get secret postgres-secret -o jsonpath='{.data.POSTGRES_USER}' | base64 -d)"
        echo "  Password: $(kubectl --kubeconfig={{.KUBECONFIG}} get secret postgres-secret -o jsonpath='{.data.POSTGRES_PASSWORD}' | base64 -d)"
        echo "  Database: $(kubectl --kubeconfig={{.KUBECONFIG}} get secret postgres-secret -o jsonpath='{.data.POSTGRES_DB}' | base64 -d)"
        echo ""
        echo "‚ö†Ô∏è  Keep these credentials secure!"

