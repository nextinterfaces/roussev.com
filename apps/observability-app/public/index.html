<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>Observability experimentations</title>
    <link rel="stylesheet" href="https://roussev.com/styles.css">
    <style>
        .architecture-diagram {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--bg-secondary, #f5f5f5);
            border-radius: 8px;
            overflow-x: auto;
        }
        .architecture-diagram h2 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--text-primary, #333);
        }
        .profile-header a {
            color: var(--link-color, #0969da);
            text-decoration: none;
        }
        .profile-header a:hover {
            text-decoration: underline;
        }
        @media (prefers-color-scheme: dark) {
            .profile-header a {
                color: var(--link-color, #58a6ff);
            }
        }
        .link-icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-right: 8px;
            display: inline-block;
        }
        .token-box {
            display: inline-flex;
            gap: 0.25rem;
            align-items: center;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        .token-input {
            width: 120px;
            padding: 0.25rem 0.5rem;
            font-family: monospace;
            font-size: 0.7rem;
            border: 1px solid var(--border-color, #ccc);
            border-radius: 4px;
            background: var(--bg-primary, white);
            color: var(--text-primary, #333);
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .copy-btn {
            padding: 0.25rem 0.75rem;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .copy-btn:hover {
            background: #0052a3;
        }
        .copy-btn:active {
            background: #003d7a;
        }
        .copy-btn.copied {
            background: #28a745;
        }
        @media (prefers-color-scheme: dark) {
            .architecture-diagram {
                background: var(--bg-secondary, #1a1a1a);
            }
            .token-input {
                background: var(--bg-primary, #2a2a2a);
                color: var(--text-primary, #e0e0e0);
                border-color: var(--border-color, #444);
            }
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <div class="profile-header">
            <a href="https://roussev.com">/root</a>
        </div>

        <article class="profile-content">
            <h1>Observability</h1>

            <p>This is an Observability experiment using Bun, Postgre, OpenTelemetry and even more cool tech below ðŸ‘‡</p>

            <p>
                <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/grafana/grafana-original.svg" class="link-icon" alt="Grafana">
                <a href="/grafana/d/items-service-metrics/items-service-metrics" target="_blank">Grafana</a> - Metrics dashboard
            </p>
            <p>
                <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/prometheus/prometheus-original.svg" class="link-icon" alt="Prometheus">
                <a href="/items/prometheus-queries" target="_blank">Prometheus queries</a> using these <a href="/items/metrics" target="_blank">raw /metrics</a>
            </p>
            <p>
                <svg class="link-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#60D0E4"/>
                    <path d="M2 17L12 22L22 17" stroke="#60D0E4" stroke-width="2"/>
                    <path d="M2 12L12 17L22 12" stroke="#60D0E4" stroke-width="2"/>
                </svg>
                <a href="/jaeger" target="_blank">Jaeger</a> - Distributed tracing
            </p>
            <p>
                <svg class="link-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="2" y="4" width="20" height="3" fill="#F5A800"/>
                    <rect x="2" y="10" width="20" height="3" fill="#F5A800"/>
                    <rect x="2" y="16" width="20" height="3" fill="#F5A800"/>
                </svg>
                <a href="/grafana/explore?orgId=1&panes=%7B%220gu%22:%7B%22datasource%22:%22P8E80F9AEF21F6940%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22expr%22:%22%7Bapp%3D%5C%22items-service%5C%22%7D%22,%22queryType%22:%22range%22,%22datasource%22:%7B%22type%22:%22loki%22,%22uid%22:%22P8E80F9AEF21F6940%22%7D%7D%5D,%22range%22:%7B%22from%22:%22now-1h%22,%22to%22:%22now%22%7D%7D%7D&schemaVersion=1" target="_blank">Loki</a> - Log aggregation
            </p>

            <p><strong>Kubernetes Dashboard:</strong></p>
            <p>
                <svg class="link-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10.9 2.1l-7.2 4.2v8.4l7.2 4.2 7.2-4.2V6.3L10.9 2.1zm5.5 11.8l-5.5 3.2-5.5-3.2V7.5l5.5-3.2 5.5 3.2v6.4z" fill="#326CE5"/>
                    <circle cx="10.9" cy="10.9" r="2.5" fill="#326CE5"/>
                </svg>
                <a href="https://kube.roussev.com" target="_blank">Headlamp</a> - k8s readonly UI (copy token ðŸ‘‰ for login)
                <span class="token-box">
                    <input
                        type="text"
                        class="token-input"
                        id="headlamp-token"
                        value="eyJhbGciOiJSUzI1NiIsImtpZCI6IkYwNnVfdXZvVDdvbHhYZnVrTGhHLWg1ZEhZN1hoMHNCczEyWjBOUm5GU1EifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJoZWFkbGFtcC1yZWFkb25seSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJoZWFkbGFtcC1yZWFkb25seSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImE0ZDg0ZGU4LWRmNTctNDg2ZC1hZjJkLWYyZTlhYTkxMGFlNiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpoZWFkbGFtcC1yZWFkb25seSJ9.Sr1CZT5gAXBtT6ERnbTEPsvuUxuhQ9HtqqykIHpnoWoSNSU363p4Hs4FJGQorEgen8ne0hH_cOOIhthy7djqFxN16ctHGEpzmGPmooOswK5fA0pSKBC6NWyfxiTjmvJVar6W7K7-unX7rIp6uPLI0ULZmPwqBx7ZgAbEbhBmNC0bxUFi2W7EqttRRhIeWcFIdfr9ww5M-1LJOLCb9Usnz6pPhW8QAIhZZ2looXEWT5zclRQc0JpkWpzWpoyG0pB2HRVMl-xlGytz1QMpD4kHuBC3gAcr5pZUco0DUIgpm8_7_yNuQ7mc9WWCJC8mEwaos1352a2cE_DwsOdhMdSIXQ"
                        readonly
                    />
                    <button class="copy-btn" onclick="copyToken()">Copy</button>
                </span>
            </p>

            <p><strong>Swagger docs:</strong></p>
            <p>
                <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/swagger/swagger-original.svg" class="link-icon" alt="Swagger">
                <a href="/items/docs" target="_blank">Open API</a> of the dummy service
            </p>

            <div class="architecture-diagram">
                <h2>Architecture</h2>
                <pre class="mermaid">
graph TB
    %% Client
    subgraph ClientLayer["Client Layer"]
        Client[HTTP Client]
    end

    %% Application
    subgraph AppLayer["Application Layer"]
        App[items-service]
        ItemsEndpoint[/items endpoint/]
        MetricsEndpoint[/metrics endpoint/]
        OTel[OpenTelemetry SDK]
        Logs[Application Logs]
    end

    %% Observability
    subgraph ObsLayer["Observability Stack"]
        Prometheus[Prometheus Metrics]
        Jaeger[Jaeger Tracing]
        Grafana[Grafana Dashboards]

        subgraph LogPipeline["Logs Pipeline"]
            Promtail[Promtail / FluentBit Log Agent]
            LogStore[Loki / OpenSearch / Elastic]
        end
    end

    %% Data Layer (bottom)
    subgraph DataLayer["Data Layer"]
        DB[(PostgreSQL Database)]
    end

    %% Request Flow
    Client -->|HTTP requests| App
    App --> ItemsEndpoint
    ItemsEndpoint -->|SQL queries| DB

    %% Metrics Flow
    App --> MetricsEndpoint
    Prometheus -.->|scrapes metrics| MetricsEndpoint
    Grafana -.->|reads metrics| Prometheus

    %% Tracing Flow
    App -->|trace spans| OTel
    OTel -->|OTLP| Jaeger
    Grafana -.->|trace links| Jaeger

    %% Logs Flow
    App -->|stdout logs| Logs
    Promtail -.->|reads logs| Logs
    Promtail -->|pushes logs| LogStore
    Grafana -.->|logs query| LogStore

    %% Styling
    style App fill:#e85d04,stroke:#dc2f02,stroke-width:3px,color:#fff
    style ItemsEndpoint fill:#ffba08,stroke:#faa307,stroke-width:2px,color:#000
    style MetricsEndpoint fill:#ffba08,stroke:#faa307,stroke-width:2px,color:#000
    style OTel fill:#f5a800,stroke:#d89000,stroke-width:2px,color:#000
    style Logs fill:#6c757d,stroke:#495057,stroke-width:2px,color:#fff

    style DB fill:#336791,stroke:#2d5a7b,stroke-width:2px,color:#fff

    style Prometheus fill:#e6522c,stroke:#c93a1f,stroke-width:2px,color:#fff
    style Jaeger fill:#60d0e4,stroke:#4db8ca,stroke-width:2px,color:#000
    style Grafana fill:#f46800,stroke:#d85600,stroke-width:2px,color:#fff

    style Promtail fill:#1f78b4,stroke:#145684,stroke-width:2px,color:#fff
    style LogStore fill:#7cb342,stroke:#558b2f,stroke-width:2px,color:#fff
    style LogPipeline fill:#ffffff,stroke:#999,stroke-width:1px,color:#000

                </pre>
            </div>
        </article>
    </div>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({
            startOnLoad: true,
            theme: window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default'
        });
    </script>

    <script>
        function copyToken() {
            const tokenInput = document.getElementById('headlamp-token');
            const copyBtn = event.target;

            // Select and copy the token
            tokenInput.select();
            tokenInput.setSelectionRange(0, 99999); // For mobile devices

            navigator.clipboard.writeText(tokenInput.value).then(() => {
                // Change button text and style
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');

                // Reset after 2 seconds
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy token. Please copy it manually.');
            });
        }
    </script>
</body>
</html>

